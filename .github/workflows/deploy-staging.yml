name: Deploy to Staging

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches: [master]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NAMESPACE: uptimehive-staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: staging

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-central-1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region eu-central-1

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Run pre-deployment backup
        run: |
          echo "Creating pre-deployment backup..."
          # Delete any existing pre-deploy backup job
          kubectl delete job pre-deploy-backup -n ${{ env.NAMESPACE }} --ignore-not-found=true

          # Apply the pre-deploy backup job
          kubectl apply -f k8s/overlays/staging/pre-deploy-backup-job.yaml -n ${{ env.NAMESPACE }}

          # Wait for the backup job to complete (timeout 5 minutes)
          kubectl wait --for=condition=complete job/pre-deploy-backup -n ${{ env.NAMESPACE }} --timeout=300s || {
            echo "Backup job failed or timed out"
            kubectl logs job/pre-deploy-backup -n ${{ env.NAMESPACE }} || true
            exit 1
          }
          echo "Pre-deployment backup completed successfully"

      - name: Deploy to Staging
        run: |
          echo "Deploying to staging with image tag: staging"

          # Apply kustomize with staging overlay
          kubectl apply -k k8s/overlays/staging/

          # Wait for deployments to be ready
          echo "Waiting for deployments to be ready..."
          kubectl rollout status deployment/uptime-kuma -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/uptime-kuma-worker -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/redis -n ${{ env.NAMESPACE }} --timeout=300s

          echo "Staging deployment completed successfully"

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          kubectl get pods -n ${{ env.NAMESPACE }}
          kubectl get svc -n ${{ env.NAMESPACE }}
          kubectl get ingress -n ${{ env.NAMESPACE }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "Staging deployment failed!"
          echo "Check the workflow logs for details"
